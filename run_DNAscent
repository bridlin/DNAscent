#!/bin/bash
#
#SBATCH -o slurm.%N.%j.out
#SBATCH -e slurm.%N.%j.err
#SBATCH --mail-type END
#SBATCH --mail-user b-barckmann@chu-montpellier.fr
#
#
#SBATCH --partition long
#SBATCH --cpus-per-task 4
#SBATCH --mem  128GB



module load dorado/1.2.0
module load samtools/1.21
module load singularity


source scripts/DNAscent/config.txt

output_dir=DNAscent_$analysis_name

echo "output_dir = $output_dir"
echo "analysis name = $analysis_name"
echo "pod5 input = $pod5"



mkdir -p "$output_dir"/{basecall,demux,aligned,logs}

# =======================
# ====== CHECKS =========
# =======================

command -v dorado >/dev/null 2>&1 || { echo "dorado not found in PATH"; exit 1; }

if [ ! -d "$pod5_dir" ]; then
  echo "pod5_dir not found: $pod5_dir"; exit 1
fi



# Check for .pod5 files
shopt -s nullglob
pod5_files=("$pod5_dir"/*.pod5)
if [ ${#pod5_files[@]} -eq 0 ]; then
  echo "No .pod5 files found in $pod5_dir"; exit 1
fi
echo "Found ${#pod5_files[@]} POD5 files."

# Reference check (alignment step)
if [ ! -s "$reference" ]; then
  echo " Reference not found or empty: $reference"; exit 1
fi



# =======================
# ==== BASECALL + DEMUX =
# =======================


# (A) Classify during basecalling, then split without re-classifying
# Ref: Inline classification and --no-classify during demux. [2](https://software-docs.nanoporetech.com/dorado/latest/barcoding/barcoding/)
echo "Basecalling with inline barcoding..."
basecall_bam="$output_dir/basecall/${analysis_name}.bam"
dorado basecaller "$model" "$pod5_dir" \
    -x "$device" \
    --kit-name "$kit_name" \
    > "$basecall_bam" 2> "$output_dir/logs/basecaller.log"

echo " Demultiplexing (split per barcode, no re-classification)..."
dorado demux \
    --output-dir "$output_dir/demux" \
    --no-classify \
    "$basecall_bam" \
    --emit-summary \    
    2> "$output_dir/logs/demux.log"



# =======================
# ======= ALIGN =========
# =======================

# Align each demultiplexed BAM to the reference. You can pass extra minimap2 flags via --mm2-opts.
# Ref: dorado aligner and mm2 options. [3](https://software-docs.nanoporetech.com/dorado/latest/basecaller/alignment/)
echo "Aligning per-barcode BAMs..."


for bam in "$outdir/demux"/*.bam; do
    [ -e "$bam" ] || { echo "No demuxed BAMs found."; break; }
    bname="$(basename "$bam" .bam)"
    aligned_bam="$outdir/aligned/${bname}.bam"

    dorado aligner "$reference" "$bam" \
      > "$aligned_bam" 2> "$outdir/logs/${bname}_align.log"

  
    sorted_bam="$outdir/aligned/${bname}.sorted.bam"
        samtools sort -@ "$threads" -o "$sorted_bam" "$aligned_bam"
        samtools index -@ "$threads" "$sorted_bam"
    rm -f "$aligned_bam"
    
    echo "Aligned: $bname"
; done




# For $files in $pod5; do 
#     dorado basecaller \
#     --no-trim  \
#     hac \
#     $pod5/*.pod5 \
#     >  $output_dir/$anlysis_name\_basecalled.bam \
# ;done


# dorado demux --kit-name SQK-NBD114-24 --emit-summary --output-dir /homegalio3/radmanm/nanoporedata/020226Trypa_EdUBrdUasyncpulsechase_wSlavica/basecalled/demuxed /homegalio3/radmanm/nanoporedata/020226Trypa_EdUBrdUasyncpulsechase_wSlavica/basecalled/basecalled.bam
